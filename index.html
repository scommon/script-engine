<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Scala Script Engine by scommon</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Scala Script Engine</h1>
        <p>Fork of ScalaScriptEngine (https://code.google.com/p/scalascriptengine/).</p>

        <p class="view"><a href="https://github.com/scommon/script-engine">View the Project on GitHub <small>scommon/script-engine</small></a></p>


        <ul>
          <li><a href="https://github.com/scommon/script-engine/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/scommon/script-engine/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/scommon/script-engine">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h3>
<a name="description" class="anchor" href="#description"><span class="octicon octicon-link"></span></a>Description</h3>

<p>This library dynamically compiles scala source files and loads them as classes. Changed scala files will be recompiled and the changed class with be loaded. Multiple source paths are supported as well as compilation class path and class loading class paths (so that the scripts can load extra libraries).</p>

<p>Classpath detection can be automatic (effectively using the classpath of the caller) or manual.</p>

<p>Different compilation and refreshing strategies are provided to suit various purposes.</p>

<h3>
<a name="news" class="anchor" href="#news"><span class="octicon octicon-link"></span></a>News</h3>

<ul>
<li>23/07/2013 : v1.3.5 is available with error reporting fixes and only for scala 2.10.2</li>
<li>30/06/2013 : v1.3.4 is available, with error reporting fixes and only for scala 2.10.2</li>
<li>24/04/2013 : v1.3.2 is available with class loading listeners</li>
<li>02/03/2013 : v1.3.1 is available with better error reporting</li>
<li>20/02/2013 : v1.3.0 is available with better support for using ScalaScriptEngine within an IDE and multiple target class folders.</li>
<li>09/02/2013 : v1.2.1 is now available with better compilation error reporting and sbt compatibility fix.</li>
<li>23/01/2013 : snapshots of v1.2.1 are available in sonatype snapshot repo. Those fix sbt issues.</li>
<li>12/01/2013 : v1.2.0 for scala 2.10.0 is now available</li>
<li>16/10/2012 : v1.2.0 : Sandbox, better eval() and compilation for scala 2.9.2 and 2.10.0-M7 . For Sandbox please look at the end of this page.</li>
<li>25/08/2012 : v1.1.0 : this has support for evaluating scala code from a String.</li>
<li>22/07/2012 : migrated to git</li>
<li>19/07/2012 : v1.0.0 : v0.6.4 is promoted to v1.0.0</li>
</ul><p><a href="wiki/News">more...</a></p>

<h3>
<a name="examples" class="anchor" href="#examples"><span class="octicon octicon-link"></span></a>Examples</h3>

<p><a href="src/test/scala/examples">Please click to view examples</a></p>

<p><a href="src/test/scala/com/googlecode/scalascriptengine/EvalCodeSuite.scala">eval(): Evaluating scala code from a String</a></p>

<h3>
<a name="discuss" class="anchor" href="#discuss"><span class="octicon octicon-link"></span></a>Discuss</h3>

<p>at <a href="http://groups.google.com/group/scala-script-engine">http://groups.google.com/group/scala-script-engine</a></p>

<h3>
<a name="maven" class="anchor" href="#maven"><span class="octicon octicon-link"></span></a>Maven</h3>

<p>Both scalascriptengine and scala-compiler must be added as dependencies:</p>

<div class="highlight"><pre><span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.googlecode.scalascriptengine<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>scalascriptengine<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.3.2-${scala.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.scala-lang<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>scala-compiler<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${scala.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>

<p>Please add the sonatype releases repository to your repositories:</p>

<div class="highlight"><pre><span class="nt">&lt;repositories&gt;</span>
        <span class="nt">&lt;repository&gt;</span>
                <span class="nt">&lt;id&gt;</span>sonatype.releases<span class="nt">&lt;/id&gt;</span>
                <span class="nt">&lt;url&gt;</span>https://oss.sonatype.org/content/repositories/releases/<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;/repository&gt;</span>
<span class="nt">&lt;/repositories&gt;</span>
</pre></div>

<h3>
<a name="sbt" class="anchor" href="#sbt"><span class="octicon octicon-link"></span></a>sbt</h3>

<pre><code>"com.googlecode.scalascriptengine" % "scalascriptengine" % "1.3.2-${scala.version}",
"org.scala-lang" % "scala-compiler" % "${scala.version}" // where i.e. ${scala.version} = 2.9.2
</code></pre>

<h3>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h3>

<p>This is not the most efficient usage of the library, but is the one with the most expected behavior:</p>

<div class="highlight"><pre><span class="c1">// sourceDir is the folder with the scala source files</span>
<span class="k">val</span> <span class="n">sse</span> <span class="k">=</span> <span class="nc">ScalaScriptEngine</span><span class="o">.</span><span class="n">onChangeRefresh</span><span class="o">(</span><span class="n">sourceDir</span><span class="o">)</span>
<span class="c1">// get the class which should extend statically</span>
<span class="c1">// compiled trait ClzTrait</span>
<span class="k">val</span> <span class="n">clzTraitClass</span><span class="k">=</span><span class="n">sse</span><span class="o">.</span><span class="n">get</span><span class="o">[</span><span class="kt">ClzTrait</span><span class="o">](</span><span class="s">"my.dynamic.Clz"</span><span class="o">)</span>
<span class="c1">// or get a new instance</span>
<span class="k">val</span> <span class="n">clzTrait</span><span class="k">=</span><span class="n">sse</span><span class="o">.</span><span class="n">newInstance</span><span class="o">[</span><span class="kt">ClzTrait</span><span class="o">](</span><span class="s">"my.dynamic.Clz"</span><span class="o">)</span>
</pre></div>

<p>Please note that scala classes that are going to be requested from ScalaScriptEngine, should be declared in a synonymous scala file, i.e. my.Foo should be under my/Foo.scala in order for change detection to work.</p>

<h3>
<a name="avoiding-compilation-during-development" class="anchor" href="#avoiding-compilation-during-development"><span class="octicon octicon-link"></span></a>Avoiding compilation during development</h3>

<p>The engine can be configured to use classes as they are compiled by an IDE.</p>

<div class="highlight"><pre><span class="k">val</span> <span class="n">sse</span><span class="k">=if</span><span class="o">(</span><span class="n">is</span> <span class="n">running</span> <span class="k">for</span> <span class="n">production</span><span class="o">)</span>
  <span class="o">...</span><span class="n">normal</span> <span class="n">script</span> <span class="n">engine</span> <span class="n">initialization</span> <span class="k">for</span> <span class="n">production</span> <span class="n">env</span>
<span class="k">else</span>
  <span class="k">new</span> <span class="nc">ScalaScriptEngine</span><span class="o">(</span><span class="nc">Config</span><span class="o">(</span><span class="n">sourcePaths</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
    <span class="nc">SourcePath</span><span class="o">(...</span><span class="n">source</span> <span class="n">folder</span><span class="o">,</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span> <span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">scala</span><span class="o">...,</span> <span class="o">...</span> <span class="n">existing</span> <span class="k">class</span> <span class="nc">folder</span><span class="o">,</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span> <span class="n">target</span><span class="o">/</span><span class="n">classes</span><span class="o">)</span>
  <span class="o">)))</span> <span class="k">with</span> <span class="nc">DevUseIDECompiledClassesOnly</span>
</pre></div>

<p>Now scripts can be recompiled within the IDE and, without restarting your java app, the compiled classes will be reloaded on every sse.get or sse.newInstance.</p>

<p>NOTE: this frequently throws away a classloader and it is not recommended for production as it is slow and will cause a PermGen issue. But it is very handy during development.</p>

<h3>
<a name="examples-1" class="anchor" href="#examples-1"><span class="octicon octicon-link"></span></a>Examples</h3>

<ul>
<li><a href="src/test/scala/examples">Please click to view examples</a></li>
</ul><h3>
<a name="how-does-it-work" class="anchor" href="#how-does-it-work"><span class="octicon octicon-link"></span></a>How does it work</h3>

<p>The ScalaScriptEngine class works by keeping versions of compiled source directories. Version 1 can be loaded during initialization of the engine or during the request for the first script. After that, there are different policies to refresh the changed source files:</p>

<ul>
<li>
<strong>manual</strong>: the client of the engine manually calls ScalaScriptEngine.refresh to check &amp; recompile changed classes in the source directories.</li>
<li>
<strong>on-change-refresh</strong>: as soon as the src file for a requested class changes, the source dirs are recompiled (only changed files). The code requesting for the changed class blocks till compilation completes</li>
<li>
<strong>on-change-refresh-async</strong>: as soon as the src file for a requested class changes, the source dirs are recompiled (only changed files). The code requesting for the changed class resumes execution but uses an old version of the class till compilation completes. This method scales up better for i.e. servers that need to process hundreds of requests per second and blocking till compilation completes is not an option.</li>
<li>
<strong>timed refresh</strong>: a background thread periodically scans the source folders for changes and recompiles them. During recompilation, old version classes are returned by the engine but as soon as compilation completes the new version classes are used.</li>
</ul><p>In case of compilation errors, the previous version remains in use.</p>

<h3>
<a name="sandbox" class="anchor" href="#sandbox"><span class="octicon octicon-link"></span></a>Sandbox</h3>

<p>Please view the test suites:</p>

<ul>
<li>
<a href="testfiles/SandboxSuite/test.policy">policy file</a> </li>
<li><a href="src/test/scala/com/googlecode/scalascriptengine/SandboxSuite.scala">Example 1</a></li>
<li><a href="src/test/scala/com/googlecode/scalascriptengine/SandboxAllowOnlySuite.scala">Example 2</a></li>
</ul><p>ScalaScriptEngine can be configured to work with a Java sandbox and in addition offers extra help in terms of SecureManager and limited classloading for scripts.</p>

<h3>
<a name="sandbox-and-securemanager" class="anchor" href="#sandbox-and-securemanager"><span class="octicon octicon-link"></span></a>Sandbox and SecureManager</h3>

<p>create a policy file:</p>

<pre><code>grant codeBase "file:${user.home}/-" {
        permission java.security.AllPermission;
};

grant codeBase "${script.classes}/-" {
        permission java.io.FilePermission       "/home","read";
};
</code></pre>

<p>Register a SecurityManager with the help of SSESecurityManager:</p>

<div class="highlight"><pre><span class="k">import</span> <span class="nn">com.googlecode.scalascriptengine._</span>

<span class="c1">// create the default config with a Source Dir. The temp directory where</span>
<span class="c1">// the compiled classes are stored is in the OS tmp folder.</span>
<span class="k">val</span> <span class="n">config</span> <span class="k">=</span> <span class="nc">ScalaScriptEngine</span><span class="o">.</span><span class="n">defaultConfig</span><span class="o">(</span><span class="n">sourceDir</span><span class="o">)</span>
<span class="c1">// We are now going to create a security manager with the test.policy</span>
<span class="c1">// file. We need to fill the placeholders of test.policy</span>
<span class="nc">System</span><span class="o">.</span><span class="n">setProperty</span><span class="o">(</span><span class="s">"script.classes"</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="n">outputDir</span><span class="o">.</span><span class="n">toURI</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
<span class="nc">System</span><span class="o">.</span><span class="n">setProperty</span><span class="o">(</span><span class="s">"java.security.policy"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"test.policy"</span><span class="o">).</span><span class="n">toURI</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
<span class="k">val</span> <span class="n">sseSM</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SSESecurityManager</span><span class="o">(</span><span class="k">new</span> <span class="nc">SecurityManager</span><span class="o">)</span>
<span class="nc">System</span><span class="o">.</span><span class="n">setSecurityManager</span><span class="o">(</span><span class="n">sseSM</span><span class="o">)</span>
</pre></div>

<p>The SSESecurityManager is by default not active. So the rest of the java code will run like if not under a security manager. The SSESecurityManager activates the delegate SecurityManager as follows:</p>

<div class="highlight"><pre><span class="k">val</span> <span class="n">sse</span> <span class="k">=</span> <span class="nc">ScalaScriptEngine</span><span class="o">.</span><span class="n">onChangeRefresh</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="mi">5</span><span class="o">)</span>
<span class="n">sse</span><span class="o">.</span><span class="n">deleteAllClassesInOutputDirectory</span>
<span class="n">sse</span><span class="o">.</span><span class="n">refresh</span>

<span class="n">sseSM</span><span class="o">.</span><span class="n">secured</span> <span class="o">{</span>
        <span class="c1">// now the delegated SecurityManager is active and hence test.policy is active</span>
        <span class="k">val</span> <span class="n">tct</span> <span class="k">=</span> <span class="n">sse</span><span class="o">.</span><span class="n">newInstance</span><span class="o">[</span><span class="kt">TestClassTrait</span><span class="o">](</span><span class="s">"test.TryFile"</span><span class="o">)</span>
        <span class="n">tct</span><span class="o">.</span><span class="n">result</span> <span class="n">should</span> <span class="n">be</span> <span class="o">===</span> <span class="s">"directory"</span>
<span class="o">}</span>
</pre></div>

<p>Please note: SSESecurityManager can be bypassed and a global SecurityManager can be installed for both the main scala app and the scripts. SSESecurityManager is provided as a helper to avoid running all code under a security manager.</p>

<h3>
<a name="configuring-limited-access-to-loaded-classes" class="anchor" href="#configuring-limited-access-to-loaded-classes"><span class="octicon octicon-link"></span></a>Configuring limited access to loaded classes</h3>

<p>Scripts can be limited to i.e. not be able to load classes from specific packages. The decision is just a function (packageName,fullClassName)=&gt;Boolean. If true, access to fullClassName class is allowed otherwise AccessControlException is thrown.</p>

<p>The following example allows access only to certain packages and i.e. Threads can't be created by the scripts (except ofcourse if one of the allowed packages contains a class that creates threads):</p>

<div class="highlight"><pre><span class="k">val</span> <span class="n">allowedPackages</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span>
        <span class="s">"java.lang"</span><span class="o">,</span>
        <span class="s">"scala"</span><span class="o">,</span>
        <span class="s">"com.googlecode.scalascriptengine"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">config</span> <span class="k">=</span> <span class="nc">ScalaScriptEngine</span><span class="o">.</span><span class="n">defaultConfig</span><span class="o">(</span><span class="n">sourceDir</span><span class="o">).</span><span class="n">copy</span><span class="o">(</span>
        <span class="n">classLoaderConfig</span> <span class="k">=</span> <span class="nc">ClassLoaderConfig</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span>
                <span class="n">allowed</span> <span class="k">=</span> <span class="o">{</span> <span class="o">(</span><span class="n">pckg</span><span class="o">,</span> <span class="n">name</span><span class="o">)</span> <span class="k">=&gt;</span>
                        <span class="n">allowedPackages</span><span class="o">(</span><span class="n">pckg</span><span class="o">)</span> <span class="o">||</span> <span class="n">pckg</span> <span class="o">==</span> <span class="s">"test"</span>
                <span class="o">}</span>
        <span class="o">)</span>
<span class="o">)</span>
<span class="k">val</span> <span class="n">sse</span> <span class="k">=</span> <span class="nc">ScalaScriptEngine</span><span class="o">.</span><span class="n">onChangeRefresh</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="mi">5</span><span class="o">)</span>
<span class="n">sse</span><span class="o">.</span><span class="n">deleteAllClassesInOutputDirectory</span>
<span class="n">sse</span><span class="o">.</span><span class="n">refresh</span>

<span class="k">val</span> <span class="n">t</span> <span class="k">=</span> <span class="n">sse</span><span class="o">.</span><span class="n">newInstance</span><span class="o">[</span><span class="kt">TestClassTrait</span><span class="o">](</span><span class="s">"test.TryPackage"</span><span class="o">)</span>
<span class="c1">// if test.TryPackage tries to use a class not in the allowed</span>
<span class="c1">// packages, an AccessControlException will be thrown </span>
<span class="n">t</span><span class="o">.</span><span class="n">result</span>
</pre></div>

<p>Please note this mechanism works independently of a security manager. No security manager is required as this mechanism works during classloading.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/scommon">scommon</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>